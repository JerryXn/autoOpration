## 重构目标
- 拆分过长函数与文件，降低认知负担与耦合，便于维护与扩展。
- 遵循《代码简洁之道》：小函数、清晰命名、单一职责、少副作用、显式依赖。
- 为每个方法和类变量提供明确含义与类型，统一注释与关键日志策略。

## 总体结构调整
- 目录分层：
  - `src/app/`：编排与领域服务（Orchestrator、SearchRunner、DetailExecutor、Datastore、AppLogger、Models）。
  - `src/automation/`：浏览器与页面细节（BrowserOperator、Detail、XhsApiService 保持）。
  - `src/flows/`：用户流程脚本（将 `user_flow_xhs.py` 重构为 `XhsUserFlow`）。
  - `src/config/`：配置与类型（沿用 Pydantic 模型，完善注释与默认值）。
  - `src/main_xhs.py`：仅保留 CLI 入口与高层编排。
  - `tests/`：服务与编排的单元测试。

## 模块职责与接口
### Orchestrator（流程编排）
- 类：`Orchestrator`
- 责任：协调搜索→详情→动作→按需存储。
- 方法：
  - `run(keyword, do_like, do_fav, do_record, user_id)`：驱动完整流程，返回统计摘要。
- 输入/输出：明确类型与返回结构（如成功计数、错误列表）。

### SearchRunner（搜索服务）
- 类：`SearchRunner`
- 责任：统一搜索入口（curl 优先→页面回退）。
- 方法：
  - `search(keyword) -> List[NoteItem]`：返回标准化笔记条目。
- 规则：
  - 解析 `XHS_SEARCH_FILTERS_JSON` 映射到 body。
  - curl 不可用或返回空时，多轮滚动采集 `a[href*="/explore/"]`。

### DetailExecutor（详情与动作）
- 类：`DetailExecutor`
- 责任：打开详情页、获取描述、执行动作（点赞/收藏）。
- 方法：
  - `open_detail(item) -> Page`
  - `fetch_desc(page, item) -> DescResult`
  - `perform_actions(page, item, do_like, do_fav) -> Dict[str, ActionResult]`
- 策略：
  - 选择器优先级：`use[xlink\:href="#like"]/#collect`、`svg.reds-icon.*`、文本/ARIA 回退。
  - 显式等待与滚动；DOM 事件/坐标点击兜底；`aria-pressed`/类名选中态归一化。

### Datastore（数据存储）
- 类：`Datastore`
- 责任：数据库连接与写入（建表、存储笔记、更新描述、存储评论页、替换图片/标签、记录动作）。
- 方法：
  - `connect()`（短超时，失败降级为不写库）。
  - `ensure_schema(store_raw_row)`、`store_notes(items)`、`update_desc(note_id, desc)`、`store_comments_page(...)`、`log_action(...)`。

### AppLogger（关键日志）
- 类：`AppLogger`
- 责任：统一事件日志输出（封装现有 `LoggingService`），关键节点打印：
  - 导航：`goto_entry/goto_search`。
  - 搜索：`xhs_api_call search_notes`、`xhs_api_resp search_notes`。
  - 详情：`detail_open/feed_desc`。
  - 动作：`like_selectors/like_found/like_done`、`collect_*`。
  - 存储与评论：`page_store/comments_page_store`、`paginate_comments 呼叫/响应`。

### Models（类型模型）
- `NoteItem`：`note_id/xsec_token/url/title/author/likes`。
- `ActionResult`：`status/before/after/selected/strategy`。
- `CommentsPageMeta`：`status/has_more/cursor`。
- 使用 `dataclass` + 类型注解，保证含义与边界清晰。

## `main_xhs.py` 精简
- 函数：
  - `parse_args()`：解析 `--keyword/--like/--fav/--record/--userId`。
  - `bootstrap_config()`：加载配置，设置 `browser.user_data_dir/headless`（可由 `XHS_HEADLESS` 控制）。
  - `build_services(cfg)`：实例化 `BrowserOperator/SearchRunner/DetailExecutor/AppLogger`，按需构建 `Datastore`（仅在 `--record` 时）。
  - `main()`：组合调用 `Orchestrator.run(...)`，捕获顶层异常仅输出一行错误。
- 调用顺序调整：先搜索再按需连接数据库，避免阻塞导致“卡住”。

## `user_flow_xhs.py` 重构
- 类：`XhsUserFlow`
- 方法拆分：
  - `goto_entry()`、`ensure_login()`、`goto_search()`。
  - `search(keyword)`（复用 `SearchRunner`）。
  - `process_item(item)`（复用 `DetailExecutor` 与 `Datastore`）。
- 清晰注释与日志：在每步入口与出口时输出关键事件。

## 命名与注释规范
- 命名：动词+对象（如 `store_notes`、`perform_actions`）、避免含糊（如 `data`, `res` 改为具体名）。
- 注释：
  - 模块/类/方法使用中文 docstring 描述职责、输入输出、可能副作用。
  - 逻辑分支与回退策略处写简短行注释；不重复代码本意。
- 类型：所有公开方法与数据模型保证类型注解完整。

## 日志策略
- 结构化输出（JSON），关键节点：调用信息与响应摘要（避免泄露 Cookie）。
- 级别：`info/ok/error/warn`；成功写库不再冗余打印，仅错误与必要告警。
- 统一事件名与字段键，便于检索。

## 错误处理与健壮性
- 搜索：超时与空结果回退到页面解析。
- 动作：选择器未命中 → DOM/坐标兜底；属性态判定归一化。
- 数据库：连接短超时，失败降级不写库但继续流程。

## 测试
- `SearchRunner`：关键词搜索、页面回退解析 `note_id`。
- `DetailExecutor`：选择器优先级与属性选中态判定。
- `Orchestrator`：流程编排与统计结果。

## 迁移与交付
- 第一步：新增模块与骨架，入口精简为编排调用（行为等价）。
- 第二步：迁移现有实现到服务类、完善注释与关键日志。
- 保留 CLI 与环境变量兼容，日志事件名不变（仅增强关键打印）。

## 需要你的确认
- 是否按该结构与命名重构；若对目录或命名有偏好，我将按你的习惯调整。