## 目标与触发
- 当“自动运营”中勾选了“点赞/收藏”，点击“执行”后在每条笔记详情页完成对应动作。
- 权限控制沿用现有校验：`lv2` 允许点赞/收藏；未授权仅提示不执行。

## 浏览器自动化实现
- 入口：继续由 `python -m src.main_xhs` 驱动；解析 CLI 参数 `--like`、`--fav`、`--record`。
- 页面流程：
  1. 搜索并收集列表 → 遍历若干条 → 打开详情页（当前页或新标签页）。
  2. 若 `--like`：在详情页执行“点赞”；若 `--fav`：执行“收藏”。
  3. 可选 `--record`：将动作与结果写入数据库。
- 选择器与点击策略（容错/多候选）：
  - 点赞：优先 `.like-lottie`；若失败依次尝试：`.like-wrapper`、`button:has(.like-lottie)`、`[class*=like][class*=icon]`；必要时 `evaluate()` 触发 `click()` 并派发 `MouseEvent`；执行前后检测“已点赞”样式/计数变化避免二次反向点。
  - 收藏：优先 `.collect-icon`；若失败依次尝试：`button:has(.collect-icon)`、`svg.reds-icon.collect-icon`、`use[xlink\:href="#collect"]` 的父级可点击元素；执行前后检测“已收藏”状态避免反向点。
- 状态检测：
  - 已点赞：元素存在“active/liked”类或计数+1；已收藏：元素存在“active/collected”类或收藏数+1。
  - 若检测到已是目标状态则跳过点击；否则执行点击后二次检测，失败则记录错误。
- 节奏与风控：
  - 读取现有 `limits` 与 `delayRange`，在每次点击前后 `waitForTimeout`；失败重试最多 2 次；对异常页面（未加载/元素缺失）做跳过。

## 数据库设计与落库
- 复用表：`op_interactions`（已存在）更新统计与状态：
  - 字段：`note_id, liked_count, collected_count, comment_count, share_count, is_liked, is_collected, updated_at`。
  - 行为：执行成功后将 `is_liked/is_collected` 置为 1；可选地刷新计数（若能读取页面新数值）。
- 新增动作日志表：`op_action_logs`（建议）
  - 目的：追踪谁、何时、在哪条笔记执行了点赞/收藏以及结果。
  - 字段建议：
    - `id BIGINT AUTO_INCREMENT PRIMARY KEY`
    - `user_id BIGINT`（关联 `sys_users.id`）
    - `note_id VARCHAR(64)`
    - `action ENUM('like','collect')`
    - `status ENUM('ok','skip','fail')`
    - `error_msg VARCHAR(512)`
    - `page_url VARCHAR(2048)`
    - `created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP`
    - 索引：`idx_logs_note (note_id)`, `idx_logs_user_time (user_id, created_at)`
  - 写入：
    - 执行前检测已点赞/收藏：记 `skip`（已是目标状态）。
    - 执行后成功：记 `ok`；失败：记 `fail`+错误文本。
- 用户信息传递：
  - 在 Electron 主进程 `start-auto-op` 添加 `--userId=<id>` 或环境变量 `ACTION_USER_ID`，Python 侧用于日志落库。

## 代码改动点
- Node（只读不执行权限变更）：
  - `src/main.js` 的 `start-auto-op`：保留 `acts.like/acts.fav/acts.comment/acts.record`；附加 `--userId=<global.currentUser.id>`。
- Python：
  - `src/main_xhs.py`：解析 CLI 参数；在搜索→打开详情后调用 `BrowserOperator.click()` 执行动作；读取/更新 DB：
    - 使用现有 `xhs_repo_mysql.py` 的 `create_tables` 和 `upsert_interactions`；
    - 新增 `log_action(db, {...})` 写入 `op_action_logs`。
  - `automation/core/operator.py`：抽象 `perform_like()` 与 `perform_collect()` 封装点击与状态检测、重试。

## 验证与回滚保护
- 集成测试（开发环境）：
  - 模拟 `--like/--fav` 在一条笔记上执行，断言：日志存在且 `op_interactions.is_liked/is_collected=1`。
  - 对已点赞/已收藏笔记，确认写入 `skip`，不做反向点击。
- 失败处理：
  - 页面元素缺失或 DOM 改版 → 记录 `fail` 并跳到下一条；不影响整体流程。

## 交付物
- 新增/更新的 Python模块与方法（解析参数、动作执行、落库）。
- SQL 迁移（创建 `op_action_logs`）文本（或在 Python `create_tables` 中按存在性创建）。
- 说明文档：字段与使用示例、权限要求、失败重试策略。