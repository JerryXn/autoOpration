## 总体思路
- 复用现有 `pymysql` 封装，新增轻量连接池，读取仓库根 `.env` 中的 MySQL 配置。
- 在采集与行为执行的合适位置写入 `paly_` 前缀表数据。
- 插入策略：主键冲突使用 `INSERT IGNORE` 跳过；需要更新的场景提供独立 `UPDATE` 方法显式调用。

## 环境配置
- `.env` 变量：`MYSQL_HOST`、`MYSQL_PORT`、`MYSQL_USER`、`MYSQL_PASSWORD`、`MYSQL_DATABASE`
- 读取方案：优先 `os.getenv`；如无环境注入则直接读取仓库根 `.env` 并 `os.environ[...] = value`

## 新增模块
- `auto_opration_python/src/storage/mysql_pool.py`
  - 提供 `MySQLPool`：初始化时基于 `.env` 创建 N 条连接（默认 5）；`acquire()`/`release()` 方法；上下文管理支持。
  - 连接项使用与 `MySQLClient` 一致的 `pymysql` 配置（`DictCursor`、`utf8mb4`、`autocommit=False`）。
- `auto_opration_python/src/storage/sql_repo.py`
  - 统一提供 SQL 与封装方法（全部表均加 `paly_` 前缀）：
  - `insert_note_skip(note_id, title, source_url)` → `INSERT IGNORE INTO paly_notes ...`
  - `insert_comment_skip(comment)`（将解析对象映射到字段；含 `comment_id/note_id/.../raw_json/scan_batch`）
  - `insert_action_skip(actor_user_id, note_id, target_comment_id, action_type, content, success, metadata)` → `INSERT IGNORE INTO paly_actions ...`
  - `insert_batch_log(note_id, batch_no, new_count, end_reached, comment_total_hint)`
  - 需要更新时：`update_comment_fields(comment_id, fields)`（独立 UPDATE，避免与插入冲突相混淆）

## 代码接入点
- `recordings/playwright/detail_actions.py`
  - 在 `open_and_act` 的点赞/收藏成功分支：
    - 写入 `paly_actions`（`action_type='like'/'collect'`，`success=1`，`note_id` 来自 URL，`target_comment_id=NULL`）
    - 如点击失败则写 `success=0` 并记录 `metadata`（错误信息/选择器）
- `recordings/playwright/comment_actions.py`
  - 在 `handle_all_comments(page)` 调用的扫描中：每轮新增 `new_batch` 立即打印的同时，批量 `INSERT IGNORE` 到 `paly_comments`
    - `comment_id` 为主键冲突时跳过（忽略）
    - 记录 `scan_batch=轮次`、`source_url=详情页 URL`
  - 在每轮结束后，写入 `paly_comment_batches`（`batch_no`、`new_count`、`end_reached`、`comment_total_hint`）

## 字段映射
- `paly_comments`：
  - 来自现有解析：`comment_id`、`note_id`（从 `open_and_act` 传入）、`author_name`、`content`、`comment_time_text`、`location`、`is_top`、`scan_batch`、`source_url`、`raw_json`
  - 后续增强（不影响现阶段入库）：`author_user_id`、`parent_comment_id`（解析 DOM 层级时填充）
- `paly_actions`：
  - `actor_user_id`：初期使用占位（如 `'me'` 或从当前账户页解析后填充），可通过配置注入；
  - `note_id`：详情页 URL 提取；`target_comment_id`：评论级行为时填入；
  - `action_type`、`success`、`metadata`：按执行结果写入。

## 冲突策略
- 统一使用 `INSERT IGNORE`：
  - `paly_notes`、`paly_comments`、`paly_actions`、`paly_comment_batches` 插入时遇主键/唯一键冲突则跳过，不抛错。
- 更新需求采用独立 `UPDATE` 方法：调用方显式传入更新字段，避免隐式覆盖。

## 事务与池使用
- `MySQLPool.acquire()` 获取 `conn` → 手动 `begin()`/`commit()`；异常时 `rollback()` 并 `release(conn)`；批量插入时尽量同事务提交以减少 IO。
- 所有 SQL 执行沿用 `pymysql`（与现有 `MySQLClient` 风格一致），保留中文结构化日志输出（阶段/动作/状态）。

## DDL 前提
- 之前设计的带前缀表（`paly_notes/paly_comments/paly_actions/paly_comment_batches/paly_users`）已作为前置；若不存在，我将提供建表 SQL 与初始化脚本。

## 交付内容
- 新增 `mysql_pool.py` 与 `sql_repo.py` 两个模块
- 在 `detail_actions.py` 与 `comment_actions.py` 接入入库调用点（点赞/收藏/评论扫描批次）
- 使用 `.env` 中的配置启动连接池，运行时自动加载

如确认，我将按此方案添加模块与改造调用点，并保证主键冲突时插入跳过。