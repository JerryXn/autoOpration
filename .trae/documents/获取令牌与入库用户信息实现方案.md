## 结论与现状

* Coze/ItApi 的令牌不通过接口返回，来自环境变量：

  * Coze 使用 `Authorization: Bearer ${COZE_TOKEN}`，见 auto\_opration\_python/src/invoke/remote\_invoke.py:70、105；令牌加载见 auto\_opration\_python/src/invoke/remote\_invoke.py:53–59。

  * ItApi 使用查询参数 `key=${API_KEY}`，见 auto\_opration\_python/src/clients/itapi\_client.py:47–68；`.env` 中的 `API_KEY` 被自动读取（不显示具体值）。

* 小红书 `xsec_token` 可在“单独执行检索/页面请求”时获取：

  * 接口检索返回项中携带，解析见 auto\_opration\_python/src/automation/services/xhs\_api.py:184–226。

  * 页面搜索锚点的 `href` 携带，解析见 auto\_opration\_python/src/app/api\_helpers.py:86–103。

* 当前用户入库：

  * 已入库 `xhs_users(user_id,nickname,avatar)`，见 auto\_opration\_python/src/storage/xhs\_repo\_mysql.py:10–16、291–305。

  * `desc`（用户简介）与 `red_id` 已可从页面接口获取，见 auto\_opration\_python/src/automation/services/xhs\_user.py:18–31，但尚未入库。

## 目标

* 单次请求即可获得当前需要的令牌/上下文并入库用户信息：`nickname`、`desc`、`user_id`、`red_id`。

* 每次触发该请求均入库，重复忽略/幂等更新（不报错）。

## 技术策略

* 令牌获取：

  * Coze/ItApi：从环境变量读取，不设计“获取当前 token”的接口调用。

  * 小红书：通过搜索接口或页面解析拿到 `xsec_token`，并用于后续详情/评论请求：

    * 详情：auto\_opration\_python/src/automation/services/xhs\_api.py:92–105（`xsec_token` 在 body）。

    * 评论分页：auto\_opration\_python/src/automation/services/xhs\_api.py:107–121（`xsec_token` 在 query）。

* 入库与去重：MySQL + `INSERT ... ON DUPLICATE KEY UPDATE`（现有代码已广泛使用）。

## 实施步骤

1. 扩展表结构：

   * 在 `xhs_users` 增加列：`desc TEXT NULL`、`red_id VARCHAR(64) NULL`。

   * 如需以 `red_id` 唯一识别，可加唯一键：`UNIQUE KEY uniq_red_id (red_id)`。
2. 扩展写入函数 `upsert_user(...)`：

   * SQL 改为：

     * `INSERT INTO xhs_users(user_id,nickname,avatar,desc,red_id,created_at,updated_at) VALUES(?,?,?,?,?,NOW(),NOW()) ON DUPLICATE KEY UPDATE nickname=VALUES(nickname),avatar=VALUES(avatar),desc=VALUES(desc),red_id=VALUES(red_id),updated_at=NOW()`。

   * 参数来源：

     * 基础 `user_id`/`nickname`/`avatar` 来自搜索项（已有）。

     * `desc`/`red_id` 来自页面请求 `fetch_me_with_page(...)` 的 `data`，见 auto\_opration\_python/src/automation/services/xhs\_user.py:4–33。
3. 接入时机（保证“每次请求均入库”且幂等）：

   * 在现有分页流程的 `_on_page` 内或流程开始处调用 `fetch_me_with_page(page)`，将返回的 `data` 合并到待写入对象后调用 `upsert_user`。

   * 参考写入链路：`store_items(...)` 已在每页对作者做 `upsert_user`，见 auto\_opration\_python/src/storage/xhs\_repo\_mysql.py:471–505；在此处补充 `desc`/`red_id` 字段即可。

## 幂等与重复忽略

* 主键冲突（`user_id`）用 `ON DUPLICATE KEY UPDATE` 覆盖更新，满足“重复则忽略”的语义。

* 若对 `red_id` 建唯一索引，同样用 `ON DUPLICATE KEY UPDATE` 保持一致策略。

* 事务包裹与批量写入维持现有模式（见 auto\_opration\_python/src/storage/xhs\_repo\_mysql.py:471–527）。

## 变更影响面

* DDL 初始化与迁移位置：auto\_opration\_python/src/storage/xhs\_repo\_mysql.py:8–176（建议在此对齐或新增迁移）。

* 仅限数据层与入库函数扩展，不影响上层抓取/接口调用逻辑；Coze/ItApi 的凭据读取保持原样。

## 验证

* 运行现有流程，观察：

  * `search_notes`/页面抓取能解析到 `xsec_token`（日志与返回对象包含）。

  * 每页/每次请求后 `xhs_users` 里 `desc` 与 `red_id` 被更新。

* SQL 检查唯一冲突不报错、数据按预期覆盖更新。

## 安全

* 不输出 `.env` 中的真实密钥值；严禁日志打印完整令牌。现有 Coze 日志已做脱敏，见 auto\_opration\_python/src/invoke/remote\_invoke.py:26–41。

