## 概述
- 目标：将评论、点赞、收藏的控制权限与策略集中至“自动运营”页面，统一配置、统一透传，并严格约束到 Playwright 的浏览器动作（点击、输入、等待响应）。
- 范围：界面控件、筛选与请求体、策略与概率/限额、后端控制器、Playwright 行为绑定、速率与风控、日志入库、测试与验证。

## 当前能力
- 行为开关与限速：`browse/like/fav/comment/record`，每轮数量、每分钟/每小时上限、随机延迟。
- 搜索与筛选：类型（图文/视频）、排序（综合/最新/最多点赞/最多评论/最多收藏）、发布时间/搜索范围/位置距离（中文标签映射至请求体），地理位置默认启用。
- 详情抓取：搜索后按条打开详情页，抓取描述/图片/标签入库。
- 评论流水：页面回复与成功/失败入库（含接口响应原文）。

## 搜索参数映射（与 curl 对齐）
- 顶层字段：`{"keyword","page","page_size","search_id","sort":"general","note_type","ext_flags":[],"filters":[],"geo","image_formats":["jpg","webp","avif"]}`
- 类型：`note_type`（图文=2，视频=1）。
- 排序：`filters[{type:"sort_type", tags:[general|time_descending|popularity_descending|comment_descending|collect_descending]}]`。
- 发布时间：`filters[{type:"filter_note_time", tags:[不限|一天内|一周内|半年内]}]`。
- 搜索范围：`filters[{type:"filter_note_range", tags:[不限|已看过|未看过|已关注]}]`。
- 位置距离：`filters[{type:"filter_pos_distance", tags:[不限|同城|附近]}]`。

## 策略区设计（新增）
- 概率控制（默认 100%）：
  - 评论概率（0–100）。
  - 点赞概率（0–100）。
  - 收藏概率（0–100）。
- 最大操作数（本轮）：
  - 最大点赞数（示例：50）。
  - 最大评论数（示例：20）。
  - 最大收藏数（示例：30）。
- 每笔记最大评论数：
  - 单笔记最多回复条数（示例：2）。
- 其他策略（与概率/限额并用）：
  - 评论：目标范围（仅作者/仅非作者/全部）、文本长度最小/最大、敏感词过滤、连续失败暂停阈值。
  - 点赞：Note门槛（最小点赞数/最小评论数/类型）、防重复。
  - 收藏：类型偏好（图文/视频/全部）、防重复。

## IPC 与透传
- 前端→主进程：`start-auto-op` Payload 增加 `policies`：
  - `policies: { dryRun: boolean, comment: { probability, maxTotal, perNoteMax, ... }, like: { probability, maxTotal, ... }, fav: { probability, maxTotal, ... }, risk: { failPauseThreshold, ... } }`。
- 主进程→Python 环境：
  - `XHS_SEARCH_FILTERS_JSON`（筛选）。
  - `XHS_ACTION_POLICIES_JSON`（策略与概率/限额）。
  - `XHS_USE_GEO=1`、`XHS_GEO_BASE64` 或 `XHS_GEO_LAT/LON`（定位）。

## 后端控制器（Python）
- `ActionController`：
  - 解析 `XHS_ACTION_POLICIES_JSON`。
  - 判定：`should_comment/should_like/should_fav/should_browse`。
  - 概率：通过 `random()<probability/100` 决定是否执行，未命中输出“概率跳过”。
  - 限额：维护本轮计数（点赞/评论/收藏），超过 `maxTotal` 跳过；维护 `perNoteMax`（评论），超过跳过该笔记。
  - 统一限速：`next_delay()` 返回随机延迟，所有 Playwright 动作前 sleep。
  - 风控：连续失败计数达到阈值暂停当轮（`pause_all=True`）。
  - dry-run：所有动作改为 no-op，仅日志。

## Playwright 行为绑定
- 评论：在调用 `op.reply_to_comment` 之前做策略判定（门槛/概率/限额/每笔记最大值）；通过才执行输入与点击；失败进入风控。
- 点赞：新增/完善 `op.like_note`；判定通过再 `page.locator('…点赞…').click()`；防重复与限额生效。
- 收藏：新增/完善 `op.fav_note`；同点赞绑定策略与点击动作。
- 浏览：打开详情页前做 `should_browse` 判定。

## 日志与入库
- 决策日志：`[决策] 执行/跳过`（含 `reason: probability_skip | max_total_reached | per_note_max_reached | threshold_not_met | dry_run | risk_paused`）。
- 执行日志：`[结果] 成功/失败`（含状态与文本摘要）。
- 汇总：成功/失败/跳过计数与 Top 失败原因。
- 入库保持现有：`op_notes/op_images/op_note_tags/op_comment_replies/op_comment_reply_responses`。

## 测试与验证
- 单元测试：
  - 构造请求体映射（图文/视频 + 排序/时间/范围/距离，已有）。
  - 策略判定：给定 Note 指标与策略，断言评论/点赞/收藏的执行与跳过（含概率与限额）。
  - 风控与 dry-run：模拟失败累计与无动作执行。
- 集成测试：以 Playwright no-op 模拟，验证决策→动作绑定链路。

## 默认与安全
- 默认概率 100%；默认开启风控与防重复；dry-run 默认关闭。
- 对输入做边界与合法性校验；异常统一日志并安全回退。

## 迭代路线
1. 前端添加策略控件与透传（含概率/最大操作数/每笔记最大评论数）。
2. Node 主进程透传为环境变量。
3. Python 实现 `ActionController` 并在 `BrowserOperator`/流水中绑定。
4. Playwright 添加点赞/收藏操作与判定。
5. 日志与汇总完善；
6. 测试补齐并通过；
7. 第二阶段支持运行中实时控制（暂停/恢复/dry-run）。