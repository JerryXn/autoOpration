## 已确认约束
- 使用你现有 env 的数据库（沿用你提供的连接/驱动，不内置本地文件 DB）。
- 不保存截图文件，仅保存媒体与页面 URL；快照仅存 JSON/必要 DOM 片段。

## 采集频率与停留阈值（可配置）
- scroll 事件：采样每 300–500ms，合并连续同向滚动为一条（delta_y 累加）。
- swipe_left/right：离散事件，每次手势一条；若 300ms 内重复手势合并为一条并累计时长。
- hover：当同一目标元素停留 ≥ 500ms 记录一次；随后每 2s 追加一次心跳（duration 累积）。
- view_image：图片可视区域 ≥ 60% 且停留 ≥ 800ms 记录一次；若继续停留每 2s 心跳更新累计停留时长。
- open_link/like/fav/comment：瞬时事件，记录一次并附结果。
- note_visit：进入详情即新建；离开或脚本结束时更新总时长。
- 最小停留时长建议：
  - 计为“已浏览图片”：≥ 1200ms
  - 计为“已浏览笔记”：总停留 ≥ 5000ms 或浏览 ≥ 3 张图片（其一满足）

## 数据模型与 SQL
- 使用之前提供的表结构（platform/creator/note/note_media/note_stats/tag/note_tag/browse_session/browse_event/note_visit/raw_snapshot/error_log）。
- 保留 URL 字段：note.url、note_media.url、raw_snapshot.file_path 为空；raw_snapshot.content 存 JSON。
- 关键 UPSERT/记录 SQL 与注释沿用（不含截图路径写入）。

## 平台适配与抽象
- 适配器：XHS 解析器将页面结构映射为统一字段（标题、作者、媒体、统计、受限状态）。
- 事件采集：统一枚举与字段；由适配器提供滚动容器、媒体轮播定位与可视判断。

## 存储驱动与事务
- Storage 接口使用你 env 的数据库连接：
  - `saveNote`/`saveMedia`/`upsertStats` 使用 UPSERT；
  - `appendSession` 新建事务；
  - `appendEvents` 批量插入（≤ 200 条/批）并在失败时降级为单条重试；
  - `appendSnapshots` 写入 JSON；
  - `appendErrors` 写入错误码与上下文。

## 操作→反馈闭环
- 每个动作（滚动/滑动/查看图片）都有记录与结果字段；失败会写 error_log 与简要 DOM/JSON 快照。
- 用户介入时立即停止并写会话结束与最后一条事件。

## 指标与查询
- 最近 N 次会话浏览时长分布、图片查看完成度、受限率/风控命中率、作者与标签画像。
- 常用索引：browse_event(session_id,event_time)、note(author_id)、note(url)、note_visit(session_id,note_id)。

## 实施步骤
1) 绑定你 env 的数据库连接，初始化表结构（若不存在则创建）。
2) 实现 XHS 适配器与事件采集逻辑（按上述频率与阈值）。
3) 在自动运营详情页流程中调用存储接口：创建会话→记录事件→记录 visit→落库 note/media/stats→快照/错误。
4) 提供基础查询与导出（会话、事件、媒体）。

## 待你确认的参数
- scroll 采样：300–500ms
- view_image 判定：可视 ≥ 60%、停留 ≥ 800ms；“已浏览”阈值 1200ms
- “已浏览笔记”阈值：停留 ≥ 5000ms 或浏览 ≥ 3 张图片
- 事件批量大小：≤ 200 条/批
- 是否需要标签/话题解析与入库（默认开启）

确认后我将按此方案开始实现，数据库连接将直接复用你的 env 配置。