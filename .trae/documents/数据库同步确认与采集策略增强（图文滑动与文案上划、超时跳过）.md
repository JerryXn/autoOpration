## 已确认

* 数据库：MySQL，连接配置在 `.env` 中；允许我读取并使用。

* 文案“足够内容”判定：依赖当前界面的选择器定位与图片轮播的终止标记，而非单纯数量阈值。

## MySQL同步方案

* 读取 `.env`（如 `DB_HOST/DB_PORT/DB_USER/DB_PASSWORD/DB_NAME`）建立连接（使用 `mysql2`）。

* 表存在检查：

```sql
SELECT table_name FROM information_schema.tables
WHERE table_schema = DATABASE()
  AND table_name IN ('platform','creator','note','note_media','note_stats','tag','note_tag','browse_session','browse_event','note_visit','raw_snapshot','error_log');
```

* 缺失则执行 DDL（MySQL 语法，带注释）：

```sql
CREATE TABLE IF NOT EXISTS platform (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  code VARCHAR(32) NOT NULL UNIQUE, -- 平台编码，如 xhs/douyin
  name VARCHAR(64) NOT NULL,
  enabled TINYINT(1) NOT NULL DEFAULT 1,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB;

CREATE TABLE IF NOT EXISTS creator (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  platform_id BIGINT NOT NULL,
  external_id VARCHAR(128) NOT NULL, -- 平台作者ID
  name VARCHAR(128),
  profile_url TEXT,
  avatar_url TEXT,
  extra JSON,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY uniq_creator (platform_id, external_id),
  CONSTRAINT fk_creator_platform FOREIGN KEY (platform_id) REFERENCES platform(id)
) ENGINE=InnoDB;

CREATE TABLE IF NOT EXISTS note (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  platform_id BIGINT NOT NULL,
  note_platform_id VARCHAR(128) NOT NULL, -- 平台笔记ID
  url TEXT NOT NULL,
  title TEXT,
  author_id BIGINT,
  note_type VARCHAR(16) NOT NULL, -- image_text / video
  is_restricted TINYINT(1) NOT NULL DEFAULT 0,
  published_at DATETIME NULL,
  extra JSON,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uniq_note (platform_id, note_platform_id),
  CONSTRAINT fk_note_platform FOREIGN KEY (platform_id) REFERENCES platform(id),
  CONSTRAINT fk_note_author FOREIGN KEY (author_id) REFERENCES creator(id)
) ENGINE=InnoDB;

CREATE TABLE IF NOT EXISTS note_media (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  note_id BIGINT NOT NULL,
  media_order INT NOT NULL,
  media_type VARCHAR(16) NOT NULL, -- image / video / cover
  url TEXT NOT NULL,
  width INT,
  height INT,
  duration_ms INT,
  extra JSON,
  UNIQUE KEY uniq_media (note_id, media_order),
  CONSTRAINT fk_media_note FOREIGN KEY (note_id) REFERENCES note(id) ON DELETE CASCADE
) ENGINE=InnoDB;

CREATE TABLE IF NOT EXISTS note_stats (
  note_id BIGINT PRIMARY KEY,
  like_count BIGINT,
  fav_count BIGINT,
  comment_count BIGINT,
  interact_count BIGINT,
  delta_1d BIGINT,
  delta_7d BIGINT,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_stats_note FOREIGN KEY (note_id) REFERENCES note(id) ON DELETE CASCADE
) ENGINE=InnoDB;

CREATE TABLE IF NOT EXISTS tag (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(64) NOT NULL UNIQUE
) ENGINE=InnoDB;

CREATE TABLE IF NOT EXISTS note_tag (
  note_id BIGINT NOT NULL,
  tag_id BIGINT NOT NULL,
  PRIMARY KEY (note_id, tag_id),
  CONSTRAINT fk_nt_note FOREIGN KEY (note_id) REFERENCES note(id) ON DELETE CASCADE,
  CONSTRAINT fk_nt_tag FOREIGN KEY (tag_id) REFERENCES tag(id) ON DELETE CASCADE
) ENGINE=InnoDB;

CREATE TABLE IF NOT EXISTS browse_session (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  platform_id BIGINT NOT NULL,
  entry_url TEXT NOT NULL,
  keyword VARCHAR(128),
  device_fingerprint JSON,
  started_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  ended_at TIMESTAMP NULL,
  stopped_by_user TINYINT(1) NOT NULL DEFAULT 0,
  wind_control_hit TINYINT(1) NOT NULL DEFAULT 0,
  extra JSON,
  CONSTRAINT fk_session_platform FOREIGN KEY (platform_id) REFERENCES platform(id)
) ENGINE=InnoDB;

CREATE TABLE IF NOT EXISTS browse_event (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  session_id BIGINT NOT NULL,
  note_id BIGINT NULL,
  event_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  event_type VARCHAR(32) NOT NULL,
  x INT,
  y INT,
  delta_y INT,
  duration_ms INT,
  target VARCHAR(128),
  result VARCHAR(64),
  meta JSON,
  KEY idx_event_session_time (session_id, event_time),
  CONSTRAINT fk_event_session FOREIGN KEY (session_id) REFERENCES browse_session(id) ON DELETE CASCADE,
  CONSTRAINT fk_event_note FOREIGN KEY (note_id) REFERENCES note(id) ON DELETE SET NULL
) ENGINE=InnoDB;

CREATE TABLE IF NOT EXISTS note_visit (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  session_id BIGINT NOT NULL,
  note_id BIGINT NOT NULL,
  visit_start TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  visit_end TIMESTAMP NULL,
  total_duration_ms INT,
  restricted TINYINT(1) NOT NULL DEFAULT 0,
  extra JSON,
  UNIQUE KEY uniq_visit (session_id, note_id, visit_start),
  CONSTRAINT fk_visit_session FOREIGN KEY (session_id) REFERENCES browse_session(id) ON DELETE CASCADE,
  CONSTRAINT fk_visit_note FOREIGN KEY (note_id) REFERENCES note(id) ON DELETE CASCADE
) ENGINE=InnoDB;

CREATE TABLE IF NOT EXISTS raw_snapshot (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  session_id BIGINT NOT NULL,
  note_id BIGINT NULL,
  snapshot_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  kind VARCHAR(16) NOT NULL, -- dom/json
  content LONGTEXT, -- 存 JSON/DOM 片段
  file_path TEXT,
  meta JSON,
  CONSTRAINT fk_snap_session FOREIGN KEY (session_id) REFERENCES browse_session(id) ON DELETE CASCADE,
  CONSTRAINT fk_snap_note FOREIGN KEY (note_id) REFERENCES note(id) ON DELETE SET NULL
) ENGINE=InnoDB;

CREATE TABLE IF NOT EXISTS error_log (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  session_id BIGINT NULL,
  note_id BIGINT NULL,
  error_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  code VARCHAR(32),
  message TEXT,
  context JSON,
  CONSTRAINT fk_err_session FOREIGN KEY (session_id) REFERENCES browse_session(id) ON DELETE SET NULL,
  CONSTRAINT fk_err_note FOREIGN KEY (note_id) REFERENCES note(id) ON DELETE SET NULL
) ENGINE=InnoDB;
```

## 文案与图片终止判定

* 选择器定位：

  * 正文区域：`article`, `.note-content`, `[data-qa="note-content"]`, `.content`；

  * 终止标记：评论区容器（`.comment-list`/`[data-qa="comment-list"]`）、推荐区（`.related-notes`/`.recommend-feed`）、底部操作栏（收藏/分享按钮容器）。

  * 判定：当滚动到出现终止标记（任何一个）即认为正文已尽；否则继续上划直到最大时长。

* 图片轮播终止：

  * 轮播指示器：`.swiper-pagination` 或圆点数；当当前圆点为最后一个或“下一张”按钮 `aria-disabled=true` 即终止；

  * URL重复判定：连续两次滑动后图片 URL 不变，视为已到末尾；

  * 可视判断：图片在视窗可视≥60%时才记录；

## 超时与切换

* 新增配置：`noteMaxDurationMs`（默认 15000ms）；

* 达到最大时长仍未命中终止标记：记录 `result='timeout'` 并切换下一条；

## 实施步骤

1. 读取 `.env` 并连接 MySQL，执行表检查与自动迁移（以上 DDL）。
2. 在详情页：

   * 图文：左右滑动图片，依据轮播终止规则与可视比例收集 URL；正文按终止选择器判定结束；

   * 视频：不播放，仅收集封面与正文；
3. 采集开关为 ON 时写入 `browse_session/browse_event/note_visit/raw_snapshot`；发生超时或受限立即切换下一候选。

## 需要你确认

* `noteMaxDurationMs` 默认 15000ms 是否满足你的预期；

* 是否需要为某些页面结构添加更多终止选择器（你可以提供样例选择器）。

