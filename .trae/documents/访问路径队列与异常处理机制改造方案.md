## 目标
- 用“先入先出”的访问路径队列来管理自动运营的页面跳转与处理顺序，明确从列表→详情→返回列表→下一条的流程。
- 设计完善的异常处理机制，确保在网络/DOM/受限场景下可恢复或跳过，并持续运行直到达到限制或手动终止。

## 队列与栈帧模型
- 数据结构
  - Frame：记录一次访问的上下文
    - 字段：`runId`、`keyword`、`entryUrl`、`targetHref`、`noteId(npid)`、`stage(list|detail|back)`、`attempt`、`status(success|fail|skipped)`、`error`、`ts`
  - Queue：`frames[]`，FIFO；每处理完成一个 Frame（无论成功/失败）都 `dequeue()`，并将后续步骤（如返回列表、下一条候选）入队。
  - Visited：`Set<npid>`，用于去重，写入时同步更新，防止重复处理相同详情。
- 队列操作
  - `enqueue(frame)`、`dequeue()`、`peek()`；最大长度保护（例如 1000），防止异常循环。
  - 阶段划分：
    1. 列表阶段：定位候选→生成详情 Frame 入队
    2. 详情阶段：采集与写库→生成返回列表 Frame 入队
    3. 返回阶段：回到列表→定位下一候选→生成下一详情 Frame 入队

## 主流程（关键字维度）
- 初始化：`runId`、`visited`、`limits`、注册停止快捷键。
- 对每个关键字：
  1. `ensureListPage(keyword)`：加载或回到搜索结果页→入队一个列表 Frame
  2. 处理队列：循环 `dequeue()` 执行 Frame：
     - 列表 Frame：选取未访问的第一条候选→入队详情 Frame
     - 详情 Frame：采集元数据、写库（平台/作者/笔记/媒体/会话/访问）→入队返回 Frame
     - 返回 Frame：`goBack()` 或强制加载搜索页→选取下一条候选→入队详情 Frame，直到达到 `limits.count`
- 结束：达到数量或用户终止→关闭窗口、注销快捷键、输出汇总日志。

## 异常处理设计
- 分类与策略
  - 网络/加载异常（`loadURL` 超时、404）：
    - 重试 2 次（指数退避 500ms→1500ms）；仍失败→切换到下一关键字或结束。
  - DOM 选择失败（找不到搜索框/候选/按钮）：
    - 备用选择器集合轮询；MutationObserver 等待 4s；仍失败→刷新列表页一次后重试；仍失败→跳过该 Frame。
  - 受限/隐私页面（`/404?` 或限制标识）：
    - 标记 `restricted` 入库；不再重试当前详情，直接返回列表。
  - 稳定性问题（窗口崩溃、脚本执行异常）：
    - 记录错误，尝试重建窗口一次并恢复到当前关键字列表；恢复失败→终止运行。
- 公共策略
  - 每个 Frame 附带 `attempt` 计数与 `maxAttempts`（默认 3）；超过上限则标记失败并出队。
  - 超时统一：`safeLoad(url, timeoutMs)`、`safeExecJS(fn, timeoutMs)` 包装，逾时进入重试流程。
  - 日志与事件：关键节点输出 `[autoop]`、错误输出 `[autoop-err]` 并通过 IPC 转发到渲染层。
  - 资源清理：终止或完成时关闭窗口、注销快捷键、清空队列、释放引用。

## 实现要点（文件与函数）
- `src/main.js`
  - 运行状态：`global.autoOpRuns.set(runId, { queue: [], visited: Set, ... })`
  - 辅助：
    - `enqueue(frame)` / `dequeue()` / `peek()`
    - `ensureListPage(keyword)`、`pickNextCandidate(visited)`
    - `processListFrame(frame)`、`processDetailFrame(frame)`、`processBackFrame(frame)`
    - 包装：`safeLoad(url, timeoutMs)`、`safeRunInPage(fn, timeoutMs)`
  - 写库沿用已存在的 upsert/insert 函数，保持幂等与安全。
- UI 无需改动；日志中增加“进入详情”“返回列表”“下一条详情”与错误摘要。

## 验证
- 场景：
  - 关键字含多条候选：观察 FIFO 队列处理顺序与访问去重。
  - 触发两类异常（无候选、404）验证重试与跳过策略。
  - 达到 `limits.count` 时自动关闭窗口。
- 数据：
  - `notes`/`note_media` 连续入库，无重复；`browse_sessions`/`note_visits`按序生成。

确认后我将按此方案在主进程落地队列与异常处理，并进行本地验证。