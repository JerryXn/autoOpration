## 目标
- 统一抽象不同平台的“笔记/内容”数据结构，支持小红书起步、可扩展到抖音/快手/视频号等。
- 在“浏览”过程中记录用户行为轨迹（下滑、左滑、右滑、停留时长、点击等）并与笔记归档关联。
- 设计本地数据库表结构与入库流程，给出可直接落地的 SQL（含注释），同时规划 IPC/API 层与适配器接口。

## 采集范围
- 笔记元数据：`note_id`、`title`、`content_text`、`publish_time`、`url`、`visibility/status`。
- 作者信息：`author_id_external`、`nickname`、`avatar_url`、`profile_url`、`followers`。
- 媒体资源：图片/视频列表 `type`、`url`、`w/h`、`order_index`、`thumbnail_url`。
- 指标与快照：`like/fav/comment/share/view`、`last_seen_at`、可选内容哈希。
- 浏览会话：开始/结束时间、来源页、最终详情页、是否命中风控/404。
- 浏览事件：滚动、左右滑、点击、键盘输入、停留心跳、媒体查看次序等。

## 架构抽象
- 核心模型（跨平台统一）：`Platform`、`Author`、`Note`、`NoteMedia`、`NoteMetrics`、`NoteTag`、`BrowseSession`、`BrowseEvent`、`SourcePage`。
- 平台适配器：`PlatformAdapter`（按平台实现）
  - `identify(url): PlatformCode`
  - `extractNoteMeta(document): CanonicalNote`
  - `extractAuthor(document): CanonicalAuthor`
  - `extractMedia(document): CanonicalMedia[]`
  - `selectors: { searchResultItem, detailTitle, mediaList, authorBlock }`
- 入库服务：`StorageService`
  - `upsertPlatform(platform)`、`upsertAuthor(author)`、`upsertNote(note)`、`upsertMedia(list)`、`upsertMetrics(metrics)`。
  - `beginBrowseSession(ctx)`、`appendEvent(sessionId, event)`、`endBrowseSession(sessionId, status)`。

## 数据库选择
- 本地开发：`SQLite`（简单部署、零运维），后续可迁移到 `PostgreSQL`。
- 兼容策略：尽量使用 ANSI SQL；Upsert 采用 `ON CONFLICT`（SQLite/Postgres 均支持）。

## SQL 设计（SQLite/Postgres 兼容，含注释）
```sql
-- 平台表：记录支持的平台
CREATE TABLE IF NOT EXISTS platforms (
  id            INTEGER PRIMARY KEY,
  code          TEXT NOT NULL UNIQUE,   -- 平台唯一编码：xhs/douyin/ks/wechat_video 等
  name          TEXT NOT NULL,
  created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 作者表：平台+外部作者ID唯一
CREATE TABLE IF NOT EXISTS authors (
  id                  INTEGER PRIMARY KEY,
  platform_id         INTEGER NOT NULL REFERENCES platforms(id),
  author_id_external  TEXT NOT NULL,
  nickname            TEXT,
  profile_url         TEXT,
  avatar_url          TEXT,
  followers           INTEGER,
  created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at          TIMESTAMP,
  UNIQUE(platform_id, author_id_external)
);

-- 笔记主表：平台+外部笔记ID唯一
CREATE TABLE IF NOT EXISTS notes (
  id                 INTEGER PRIMARY KEY,
  platform_id        INTEGER NOT NULL REFERENCES platforms(id),
  author_id          INTEGER REFERENCES authors(id),
  note_id_external   TEXT NOT NULL,
  title              TEXT,
  content_text       TEXT,
  publish_time       TIMESTAMP,
  url                TEXT,
  visibility         TEXT,     -- 可见性：public/limited/removed 等
  status             TEXT,     -- 状态：normal/404/risk_control 等
  content_hash       TEXT,     -- 可选：正文/媒体生成的摘要哈希用于去重
  created_at         TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at         TIMESTAMP,
  UNIQUE(platform_id, note_id_external)
);
CREATE INDEX IF NOT EXISTS idx_notes_platform_note ON notes(platform_id, note_id_external);

-- 媒体表：一条笔记对应多媒体项
CREATE TABLE IF NOT EXISTS note_media (
  id            INTEGER PRIMARY KEY,
  note_id       INTEGER NOT NULL REFERENCES notes(id) ON DELETE CASCADE,
  type          TEXT NOT NULL,   -- image/video
  url           TEXT NOT NULL,
  width         INTEGER,
  height        INTEGER,
  order_index   INTEGER,         -- 顺序（图文页的图片序号/视频序号）
  thumbnail_url TEXT,
  created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(note_id, type, url)
);
CREATE INDEX IF NOT EXISTS idx_media_note ON note_media(note_id);

-- 指标表：最新观测到的指标（可按需扩展为时序）
CREATE TABLE IF NOT EXISTS note_metrics (
  note_id        INTEGER PRIMARY KEY REFERENCES notes(id) ON DELETE CASCADE,
  like_count     INTEGER,
  fav_count      INTEGER,
  comment_count  INTEGER,
  share_count    INTEGER,
  view_count     INTEGER,
  last_seen_at   TIMESTAMP
);

-- 标签表：标签或话题
CREATE TABLE IF NOT EXISTS note_tags (
  id        INTEGER PRIMARY KEY,
  note_id   INTEGER NOT NULL REFERENCES notes(id) ON DELETE CASCADE,
  tag       TEXT NOT NULL
);
CREATE INDEX IF NOT EXISTS idx_note_tags_note ON note_tags(note_id);

-- 浏览会话：一次进入详情页的周期
CREATE TABLE IF NOT EXISTS browse_sessions (
  id              INTEGER PRIMARY KEY,
  platform_id     INTEGER NOT NULL REFERENCES platforms(id),
  note_id         INTEGER REFERENCES notes(id),
  source_url      TEXT,        -- 来源页（搜索页/探索页）
  detail_url      TEXT,        -- 详情页地址（若因风控为404则记录跳转地址）
  started_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  ended_at        TIMESTAMP,
  status          TEXT,        -- success/404/risk_control/user_stop 等
  meta            TEXT         -- 额外信息 JSON（如 error_code、risk_msg）
);
CREATE INDEX IF NOT EXISTS idx_sessions_note ON browse_sessions(note_id);

-- 浏览事件：细粒度行为日志
CREATE TABLE IF NOT EXISTS browse_events (
  id           INTEGER PRIMARY KEY,
  session_id   INTEGER NOT NULL REFERENCES browse_sessions(id) ON DELETE CASCADE,
  ts           TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  type         TEXT NOT NULL,      -- scroll/swipe_left/swipe_right/click/keypress/heartbeat 等
  x            INTEGER,            -- 可选：事件坐标
  y            INTEGER,
  payload      TEXT                -- 事件详细 JSON（如滚动距离、查看的图片序号、键值等）
);
CREATE INDEX IF NOT EXISTS idx_events_session ON browse_events(session_id);

-- 来源页快照（可选）：用于还原浏览起点与上下文
CREATE TABLE IF NOT EXISTS source_pages (
  id            INTEGER PRIMARY KEY,
  session_id    INTEGER NOT NULL REFERENCES browse_sessions(id) ON DELETE CASCADE,
  page_url      TEXT NOT NULL,
  referer_url   TEXT,
  snapshot_path TEXT,       -- 可存 HTML/截图 的本地路径
  created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## Upsert 模板（SQLite/Postgres）
```sql
-- Upsert 平台
INSERT INTO platforms (code, name)
VALUES ('xhs', '小红书')
ON CONFLICT(code) DO UPDATE SET name=excluded.name;

-- Upsert 作者
INSERT INTO authors (platform_id, author_id_external, nickname, profile_url, avatar_url, followers, updated_at)
VALUES (:platform_id, :author_id_external, :nickname, :profile_url, :avatar_url, :followers, CURRENT_TIMESTAMP)
ON CONFLICT(platform_id, author_id_external)
DO UPDATE SET
  nickname=excluded.nickname,
  profile_url=excluded.profile_url,
  avatar_url=excluded.avatar_url,
  followers=COALESCE(excluded.followers, authors.followers),
  updated_at=CURRENT_TIMESTAMP;

-- Upsert 笔记
INSERT INTO notes (platform_id, author_id, note_id_external, title, content_text, publish_time, url, visibility, status, content_hash, updated_at)
VALUES (:platform_id, :author_id, :note_id_external, :title, :content_text, :publish_time, :url, :visibility, :status, :content_hash, CURRENT_TIMESTAMP)
ON CONFLICT(platform_id, note_id_external)
DO UPDATE SET
  author_id=COALESCE(excluded.author_id, notes.author_id),
  title=excluded.title,
  content_text=excluded.content_text,
  publish_time=COALESCE(excluded.publish_time, notes.publish_time),
  url=excluded.url,
  visibility=COALESCE(excluded.visibility, notes.visibility),
  status=COALESCE(excluded.status, notes.status),
  content_hash=COALESCE(excluded.content_hash, notes.content_hash),
  updated_at=CURRENT_TIMESTAMP;

-- Upsert 指标
INSERT INTO note_metrics (note_id, like_count, fav_count, comment_count, share_count, view_count, last_seen_at)
VALUES (:note_id, :like_count, :fav_count, :comment_count, :share_count, :view_count, CURRENT_TIMESTAMP)
ON CONFLICT(note_id)
DO UPDATE SET
  like_count=COALESCE(excluded.like_count, note_metrics.like_count),
  fav_count=COALESCE(excluded.fav_count, note_metrics.fav_count),
  comment_count=COALESCE(excluded.comment_count, note_metrics.comment_count),
  share_count=COALESCE(excluded.share_count, note_metrics.share_count),
  view_count=COALESCE(excluded.view_count, note_metrics.view_count),
  last_seen_at=CURRENT_TIMESTAMP;

-- 媒体：先尝试插入，冲突则跳过（或更新尺寸）
INSERT INTO note_media (note_id, type, url, width, height, order_index, thumbnail_url)
VALUES (:note_id, :type, :url, :width, :height, :order_index, :thumbnail_url)
ON CONFLICT(note_id, type, url)
DO UPDATE SET
  width=COALESCE(excluded.width, note_media.width),
  height=COALESCE(excluded.height, note_media.height),
  order_index=COALESCE(excluded.order_index, note_media.order_index),
  thumbnail_url=COALESCE(excluded.thumbnail_url, note_media.thumbnail_url);
```

## 浏览记录落库示例
```sql
-- 开始会话
INSERT INTO browse_sessions (platform_id, note_id, source_url, detail_url, status)
VALUES (:platform_id, :note_id, :source_url, :detail_url, 'running');
-- 返回 session_id 用于事件写入

-- 事件：下滑 800 像素
INSERT INTO browse_events (session_id, type, payload)
VALUES (:session_id, 'scroll', '{"deltaY":800}');

-- 事件：左滑查看图片序号2
INSERT INTO browse_events (session_id, type, payload)
VALUES (:session_id, 'swipe_left', '{"current_index":2}');

-- 事件：点击图片
INSERT INTO browse_events (session_id, type, x, y, payload)
VALUES (:session_id, 'click', 520, 360, '{"target":"image","index":2}');

-- 结束会话（正常）
UPDATE browse_sessions SET ended_at=CURRENT_TIMESTAMP, status='success', meta=NULL
WHERE id=:session_id;

-- 结束会话（风控/404）
UPDATE browse_sessions SET ended_at=CURRENT_TIMESTAMP, status='risk_control', meta='{"error_code":300031}'
WHERE id=:session_id;
```

## 采集到入库的流程
- 渲染层（详情页）：适配器解析页面 DOM，产出 `CanonicalNote/Author/Media/Metrics`。
- 主进程：
  - `beginBrowseSession(source_url, detail_url)` → `session_id`。
  - 人类行为模拟：滚动/滑动/点击时在主进程同步记录事件（或注入记录脚本）。
  - 结束时 `endBrowseSession(status, meta)`。
- 存储层：以上 Upsert 顺序——平台→作者→笔记→媒体→指标→会话→事件。

## IPC/API 规划（实现时）
- `ipcMain.handle('db-upsert-note', payload)`：包含平台、作者、笔记、媒体、指标。
- `ipcMain.handle('browse-session-begin', ctx)` / `browse-session-event` / `browse-session-end`。
- 适配器放在 `src/adapters/<platform>.js`，导出统一接口。

## 人类行为与风控
- 鼠标移动路径多段插值、悬停 300-800ms、随机滚动距离与节奏。
- 左右滑：优先触发轮播组件的真实拖拽事件（`mousedown→mousemove→mouseup`），必要时回退程序化事件。
- 用户介入：监听本地输入后立即停止会话并写入状态（`user_stop`）。

## 校验与可视化
- 在 UI 展示：当前笔记基本信息、媒体预览缩略图、指标快照、会话事件列表（时间线）。
- 导出：CSV/JSON（勾选“记录浏览信息”时自动保存）。

## 后续扩展
- 指标时序化：新增 `note_metric_timeseries`（`note_id`、`metric_type`、`value`、`ts`）。
- 内容快照：保存详情 HTML/截图路径以供复查。
- 平台扩展：新增 adapter，保持 Canonical 映射一致。

---
如确认该设计，我将：
- 建立 SQLite 初始化脚本与模块，按上述 DDL 创建表。
- 添加平台适配器骨架（先实现小红书）。
- 在“自动运营”流程里对详情页解析并落库，同时写入会话与事件。
- 在页面加“浏览记录”面板，实时展示会话事件与笔记信息。