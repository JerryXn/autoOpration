## 目标
- 支持两种发布方式：任务发布（到点触发）与立即发布（列表项按钮）。
- 自动解析你提供的发布页（小红书视频/图文）并生成稳定选择器，无需手工提供。
- 在已登录的会话窗口内，模拟人为操作填充并发布，发布成功后回写数据库。

## 架构设计
- 发布协调器（Orchestrator）：根据 `platform+type` 调用平台适配器，统一处理打开页面、选择器解析、填充、提交、结果回写。
- 平台适配器（Adapter）：为每个平台/类型定义入口与发布页 URL、选择器集合、步骤编排与回退策略。
- 会话窗口：沿用 Electron 窗口/内置浏览器；用户手动登录后，流程在该会话中运行。

## 页面自动解析
- 触发：页面 `load`/`domcontentloaded` 后运行解析器。
- 采集：
  - 输入类：`input[type=text]`、`textarea`、`[contenteditable]`、常见富文本容器
  - 上传类：`input[type=file]`（含隐藏）、上传按钮、拖拽区域
  - 操作类：发布按钮、确认弹窗按钮
- 策略（多维评分）：
  - 语义邻近：识别中文提示“标题”“正文”“上传”“发布”等文本的近邻节点
  - 属性特征：`placeholder`、`aria-label`、`name/id/class` 含关键词
  - 事件特征：绑定 `click/change/input` 的节点深度与数量
  - 布局特征：主发布容器层级与相对位置
- 产出：每类元素生成主选择器 + 2–3 备用选择器（CSS/XPath），持久化为 `adapters/xhs/image_text.json` 与 `adapters/xhs/video.json`。

## 人为操作模拟
- 随机延迟：每步骤插入 300–1200ms，步骤级穿插 1–3s 长停顿。
- 鼠标行为：`move`→`hover`→`click`，带轻微抖动；随机滚动视图。
- 键盘输入：逐字插入、触发 `input/change`；富文本通过 `execCommand/insertText` 或框架 API。

## 文件上传策略
- 首选：DevTools Protocol `DOM.setFileInputFiles` 设置真实本地路径（来自 `media_files.storage_path`）。
- 备选：点击上传按钮后查找绑定的隐藏 `<input>`；若是拖拽区，模拟拖拽事件或剪贴板粘贴（如平台支持）。

## 流程编排
1. 选择待发布项（任务到点或“立即发布”）
2. 打开发布页：
   - 图文：`https://creator.xiaohongshu.com/publish/publish?source=official&from=menu&target=image`
   - 视频：`https://creator.xiaohongshu.com/publish/publish?source=official&from=menu&target=video`
3. 等待用户完成登录（若未登录）
4. 运行解析器，获取选择器集合
5. 填充内容：标题、正文、上传封面/配图或视频
6. 可选填充：话题/标签/分类（你确认后启用默认或自定义规则）
7. 发布：点击发布并等待页面成功提示
8. 回写数据库：`status='published'`、`published_at=NOW()`；失败记录原因

## 与现有前端的衔接
- 立即发布按钮：从“仅标记发布”改为触发协调器；成功后刷新列表并显示统一成功 Toast。
- 任务发布：调度器在到点时触发协调器；仍要求用户登录会话（可配置自动提交或填充后人工确认）。

## 失败与回退
- 选择器未命中：尝试备用选择器→语义重分析→提示人工确认。
- 上传失败：切换上传方式（file input/拖拽/剪贴板），必要时降级为仅标记发布。
- 登录失效：弹出提示让用户重新登录并保留当前窗口。

## 监控与日志
- 步骤级日志：记录命中选择器、时延、异常栈；本地文件保存。
- 截图：失败保存当前页面截图，便于定位。
- 成功提示：统一 Toast（3 秒自动消失）。

## 安全与合规
- 不保存账号与密码；所有操作在用户已登录窗口中完成。
- 不输出敏感内容至日志；按需脱敏。

## 验证计划（小红书优先）
- 图文与视频各做一次解析与“演练填充”（不提交），你确认无误后启用发布。
- 成功后刷新列表显示“已发布”与发布时间，完善适配器配置。

## 需要你确认
- 是否启用“自动提交”（默认：填充后人工确认再发布）。
- 是否需要默认话题/标签/分类及其规则（例如按平台要求必填项）。
- 是否将此流程扩展到其他平台（抖音/公众号/快手等）与类型（图文/视频）。