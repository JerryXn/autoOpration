## 目标
- 打开小红书首页，执行搜索，并保存搜索结果列表（含 `href/title/author/cover` 等）。
- 循环列表，使用“新标签页”打开并进入笔记详情；记录每一步操作路径与对应 `url`。
- 在详情页输出“你想要的内容”为优先级最高的概要字段，然后补充“页面所有节点信息”。

## 现状与差距
- 现有函数：`startSession`、`search`、`openFirstNote`、`extractNote`（见 `src/playwright/index.js`）。
- 缺失：批量“列表采集与保存”、强制“新标签页”打开、统一“操作日志记录”、以及“全节点信息导出”。

## 技术实现
### 1) 列表采集与保存
- 新增：`collectSearchList(page, {limit=50, scroll=true})`
  - 选择器：`a[href*="/explore/"], a[href*="/discovery/item"]`；过滤可见且尺寸合格的元素。
  - 字段：`href`, `noteId`, `title`（卡片标题或 `aria-label`/`alt`），`author`（邻近作者元素），`cover`（卡片内首图 `img.src/currentSrc`），`snippet`（卡片文本摘要）。
  - 滚动加载：按需向下滚动，直到收集到 `limit` 或无新项。
  - 输出：返回数组，同时可选写入 JSON 文件（默认仅内存返回；如需要持久化，可在 CLI 通过参数启用）。

### 2) 操作路径与 URL 记录
- 新增：`createOpLogger()` 返回 `oplog` 队列与 `log(step, info)` 方法；在关键动作处调用：
  - `startSession` 后记录首页 URL
  - `search` 提交后记录搜索 URL 与选择器
  - 列表采集每次抓到的条目数量
  - 打开详情（新标签页）时记录 `href/target/tabId/url`
  - 详情抽取完成记录摘要与节点数量
- 所有内容最终随主输出一并返回与 `console.log`。

### 3) 新标签页打开详情
- 新增：`openNoteInNewTab(context, page, hrefOrHandle)`
  - 优先监听 `popup`：`const [newPage] = await Promise.all([ page.waitForEvent('popup'), click(...) ])`
  - 若站点阻止弹窗或无 `target=_blank`，则使用 `context.newPage()` + `newPage.goto(href)` 强制在新标签页打开。
  - 返回 `{ ok, href, url, page: newPage }`，并写入 `oplog`。

### 4) 详情页“优先打印你要的内容”+“所有节点信息”
- 扩展：在 `extractNote(page)` 基础上新增 `extractDetail(page)`，结构：
  - `summary`（优先打印）：`id`, `url`, `title`, `author`, `text`, `images`, `videos`, `published_at`, `comments_count`, （可加）`likes`, `collects`, `tags`（若可解析）。
  - `nodes`（全量）：遍历 `root`（`article/.note-content/[data-content]`）下所有节点：
    - `tag`, `id`, `class`, `attributes`（`key:value`）、`text`（去空白）、`visible`、`bbox`（`x/y/w/h`）、`href/src`。
    - 控制体量：最多 N=2000 节点；超出时分页或采样（保留主容器、媒体、标题、作者、交互区）。
  - `networks`：从现有 `videoNetMap` 合并到 `summary.videos_net`。
- 打印顺序：先 `summary`，再（如启用）`nodes`。

### 5) CLI 流与参数
- 扩展 `src/playwright/open.js`：
  - 新增参数：`--save-list`（输出列表 JSON）、`--new-tab`（新标签页模式）、`--limit N`（列表上限）。
  - 流程：`startSession` → `search(kw)` → `collectSearchList(limit)` → 循环列表：`openNoteInNewTab` → `extractDetail` → 打印。
  - 打印格式：第一行输出 `summary`，随后（按需）输出 `nodes` 与 `oplog`。

## 输出示例（结构）
- 优先打印（示例）：
```json
{
  "summary": {
    "id": "65flx...",
    "url": "https://www.xiaohongshu.com/explore/65flx...",
    "title": "成都必吃火锅清单",
    "author": "小红薯_abc",
    "text": "这家锅底太赞...",
    "images": ["https://.../img1.jpg", "https://.../img2.jpg"],
    "videos": ["https://.../v1.m3u8"],
    "videos_net": ["https://.../v1.m3u8"],
    "published_at": "11-27",
    "comments_count": 128,
    "likes": 1024,
    "collects": 203,
    "tags": ["成都", "火锅", "排队必吃"]
  }
}
```
- 列表保存（示例）：
```json
{
  "list": [
    {"href":"/explore/65flx...","title":"成都必吃火锅清单","author":"...","cover":"https://.../c1.jpg"},
    {"href":"/explore/78akp...","title":"串串推荐","author":"...","cover":"https://.../c2.jpg"}
  ]
}
```
- 操作日志（示例）：
```json
{
  "oplog": [
    {"step":"open_home","url":"https://www.xiaohongshu.com/explore"},
    {"step":"search_submit","kw":"美食","url":"https://www.xiaohongshu.com/search_result?keyword=美食"},
    {"step":"list_collect","count":40},
    {"step":"open_detail_tab","href":"/explore/65flx...","url":"https://www.xiaohongshu.com/explore/65flx..."},
    {"step":"extract_detail","summary_keys":9,"nodes":1387}
  ]
}
```

## 代码改动点（参考）
- `src/playwright/index.js`
  - 在 `module.exports` 后追加：`collectSearchList`、`createOpLogger`、`openNoteInNewTab`、`extractDetail`，并更新导出。
  - 相关参考位置：
    - `search` 已存在：`src/playwright/index.js:64`
    - `openFirstNote`：`src/playwright/index.js:91`
    - `extractNote`（可复用逻辑）：`src/playwright/index.js:155`
- `src/playwright/open.js`
  - 增加参数解析与主流程循环；按“优先打印 summary”序输出。

## 风险与对策
- 站点反爬：已设置 `launchPersistentContext` 与常见规避；仍可能出现懒加载/动态布局，需要滚动与延时。
- 新标签页阻断：若站点不使用 `target=_blank`，将直接 `context.newPage().goto(href)` 保证新标签页模式。
- 全节点导出体量过大：设置上限与采样策略；保留核心节点完整信息。

## 验证方式（本地）
- 示例命令：
  - `node src/playwright/open.js --kw "美食" --limit 30 --new-tab --save-list`
- 期望：启动浏览器→完成搜索→打印列表→依次打开详情→先打印 `summary`→可选打印 `nodes/oplog`。

## 交付
- 更新 Playwright 脚本并在本地验证；不改动仓库其他模块。确认后我将开始实现与测试，并给出可运行的脚本与示例输出。