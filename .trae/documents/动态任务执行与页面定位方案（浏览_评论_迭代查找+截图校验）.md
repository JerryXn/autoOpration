## 目标
- 基于“任务定义”动态执行浏览、评论等动作；在每个网页上自动构建 UI 树，定位静态/动态元素；对比操作前后截图验证动作是否生效；当选择器失败或不一致时，采用迭代查找与回退策略。

## 任务建模
- TaskPayload：`{ platformCode, keywords[], actions: { browse, comment, like, fav, record }, limits, type }`
- Frame 队列（FIFO）：每个 Frame 描述一个步骤与上下文：`{ runId, keyword, stage: list|detail|comment|back, targetHint, attempt, status }`
- Visited 集合：记录已处理的 `note_platform_id`，避免重复。

## 页面定位策略
- 入口：列表页 → 详情页 → 评论区 → 返回列表 → 下一条
- 列表页候选：
  - 优先 `a[href*="/explore/"]` 可见项；备用：`article[role="article"]`、`[data-note-id]` 等
  - 可见性函数：检查 `display/visibility/opacity` 与几何尺寸、遮挡情况
  - MutationObserver 等待 4s；无候选则刷新一次并重试
- 详情容器检测：
  - 选择器优先级：`div[role="dialog"]`、`overlay/modal/dialog`、`.note-detail/.detail-container`、`article[role="article"]`
  - 回退：第一个可滚动容器（`overflowY`+`scrollHeight-clientHeight`）

## UI 树采集
- 在页面内构建轻量 UI 树快照：
  - 节点信息：`tag/role/class/id/text(截断)/visible/bounds(x,y,w,h)/clickable(heuristic)/dynamic(data-*、aria-*、MutationObserver变化)`
  - 提供接口：`collectUiTree(maxNodes=1000)` 返回 JSON，用于日志与调试

## 选择器与迭代查找
- 多策略逐级回退：
  1. 静态选择器：预定义高置信度选择器（例如评论输入框、发布按钮、图片下一张）
  2. 文本匹配：中文/英文关键字（如“评论/发送/下一张/更多/展开全文”），大小写与空格模糊
  3. 角色匹配：`role=button/link`、`type=submit`、`aria-label` 模糊匹配
  4. 结构关系：在详情容器内寻找相对位置的邻近控件（上一/下一图按钮，评论输入框）
  5. 几何启发：在容器右侧或底部区域寻找最大可见按钮/箭头
  6. 坐标点击：当元素不可点击但可见，退化为坐标点击（含微抖动）
- 每一步设置最大尝试次数与退避时间，失败则标记 Frame 状态并继续队列中的下一项。

## 操作执行与校验
- 详情滚动：在容器上分段滚动（向下再向上），记录日志
- 图片翻页：优先点击“下一张”按钮；失败时对容器 `focus` 并发送 `ArrowRight`
- 评论：
  - 找到输入框 → `focus` → 输入文案 → 点击“发送/发布”按钮
  - 发送后等待列表新增一条（MutationObserver/条目计数变更）
- 截图比对：
  - 前后截图：`capturePage()` 获取全窗；若有容器，提取其区域二次截图
  - 图像差异：计算像素差比例/SSIM 简化阈值（如差异>2%判定有效）
  - 若差异不足则认为动作未生效，进入下一回退策略（如改为按键事件或点击另一路径）

## 异常与回退
- 加载/网络：`safeLoad(url, timeout)` 重试 2 次（500ms→1500ms）；失败跳过该关键字
- JS 执行：`safeRunInPage(fn, timeout)` 捕获异常并返回 `{ok:false,error}`，打印 `[autoop-err]`
- DOM 缺失：刷新一次列表页；详情页则返回列表继续下一条
- 受限/404：标记 `restricted` 写库后直接返回列表
- 窗口异常：重建一次窗口并恢复到当前关键字列表

## 日志与可观测性
- 关键日志：`browse_list/detail_scroll/image_flip/comment_send/next_pick/fail_reason`
- UI 树快照与截图（前/后）保存为临时文件路径用于追踪（可选）
- IPC 事件：将每个 Frame 的结果与错误通过 `autoop-log` 推送渲染层

## 验证流程
- 选择 1 个关键词，打开 2 条以上详情：
  - 观察详情滚动与图片翻页日志
  - 评论发送后条目计数变化
  - 返回列表并打开下一条详情
- 数据库：`notes/note_media` 连续入库、`browse_sessions/note_visits` 按序生成

确认后我将在主进程实现以上队列与迭代查找、UI 树采集与截图校验的代码，并进行一次完整验证。