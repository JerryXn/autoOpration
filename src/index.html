<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' blob: data: file: https://cdn.jsdelivr.net">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoOperation</title>
    <link rel="stylesheet" href="./styles/app.css">
    <style>
      html, body { height: 100%; margin: 0; }
      body { display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 40px 0; overflow-y: auto; font-family: system-ui, -apple-system, Segoe UI, Roboto; background: #f7f7f8; height: auto; min-height: 100%; }
      .card { width: 640px; padding: 24px; border-radius: 12px; background: #fff; box-shadow: 0 6px 24px rgba(0,0,0,0.08); margin-bottom: 20px; }
      h1 { font-size: 20px; margin: 0 0 12px; }
      p { color: #555; margin: 0 0 20px; }
      button { padding: 12px 20px; border: none; border-radius: 8px; background: #1677ff; color: #fff; font-size: 16px; cursor: pointer; }
      button:hover { background: #3b87ff; }
      .topbar { position: fixed; top: 0; left: 0; right: 0; height: 56px; background: #fff; box-shadow: 0 2px 12px rgba(0,0,0,0.06); display:flex; align-items:center; padding:0 16px; }
      .back { background:#eee; color:#333; margin-right:12px; }
      .grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:16px; }
      .item { border:1px solid #e5e5e5; border-radius:10px; padding:16px; }
      .muted { color:#888; }
      
    </style>
  </head>
  <body>
    <div class="topbar" id="topbar" style="display:none">
      <button id="back" class="back">返回</button>
      <div id="title"></div>
    </div>

    <div class="card" id="login-card">
      <h1>用户登录</h1>
      <p>登录后可进行自动化操作。</p>
      <form id="login-form">
        <div style="margin-bottom:12px; text-align:left">
          <label>账户</label>
          <input id="username" type="text" placeholder="请输入账户" style="width:100%; padding:10px; margin-top:6px; border:1px solid #ddd; border-radius:8px;">
        </div>
        <div style="margin-bottom:20px; text-align:left">
          <label>密码</label>
          <input id="password" type="password" placeholder="请输入密码" style="width:100%; padding:10px; margin-top:6px; border:1px solid #ddd; border-radius:8px;">
        </div>
        <button id="login-btn" type="submit">登录</button>
        <button id="quick-admin-btn" type="button" style="margin-left:8px; background:#00b96b">快捷登录管理员</button>
        <div id="login-msg" style="margin-top:12px; color:#c00"></div>
      </form>
    </div>

    <div class="card" id="platforms-card" style="display:none">
      <h1>请选择平台</h1>
      <div id="platforms-empty" class="muted" style="display:none">您当前没有购买任何平台的服务</div>
      <div id="platforms" class="grid"></div>
    </div>

    <div class="card" id="ops-card" style="display:none">
      <h1 id="ops-title"></h1>
      <div id="features" class="grid"></div>
    </div>

    <div class="card" id="autopub-card" style="display:none; margin-top:16px">
          <div id="autopub-tabs" class="tabs">
            <button class="tab active" data-tab="import">素材导入</button>
            <button class="tab" data-tab="publish">发布列表</button>
            <button class="tab" data-tab="tasks">任务设置</button>
          </div>
          <div id="import-pane">
            <div style="margin-bottom:12px">
              <label><input type="radio" name="source-mode" value="excel" checked> 解析 Excel</label>
              <label style="margin-left:16px"><input type="radio" name="source-mode" value="feishu"> 解析 飞书文档</label>
            </div>
            <div id="excel-pane">
              <div style="margin-bottom:8px">
                <button id="download-template" class="btn-small">下载模板(.xlsx)</button>
              </div>
              <div style="margin-bottom:8px">
                <label>选择 Excel 文件(.xlsx)</label>
                <input id="excel-file" type="file" accept=".xlsx" />
              </div>
              <div style="margin-bottom:8px">
                <label>选择图片文件（可多选）</label>
                <input id="image-files" type="file" accept="image/*" multiple />
              </div>
              <div style="margin-top:12px">
                <h3 style="margin:0 0 8px">已上传图片</h3>
                <div id="image-preview-grid" class="thumb-grid"></div>
              </div>
            </div>
            <div id="feishu-pane" style="display:none">
              <div style="margin-bottom:8px">
                <label>选择 Excel 文件(.xlsx)</label>
                <input id="feishu-excel-file" type="file" accept=".xlsx" />
              </div>
              <div style="margin-bottom:8px">
                <label>选择素材根文件夹（包含 封面 / 配图 / 人物形象 子目录）</label>
                <input id="feishu-folder" type="file" webkitdirectory directory />
              </div>
              <div id="feishu-msg" class="muted" style="margin-top:6px"></div>
            </div>
            <div style="margin-top:12px">
              <button id="confirm-upload" class="btn-small">导入</button>
              <span id="summary" class="muted" style="margin-left:12px"></span>
            </div>
            <div id="preview" style="margin-top:16px">
              <table id="preview-table" style="width:100%; border-collapse:collapse">
                <thead>
                  <tr>
                    <th style="border-bottom:1px solid #eee; text-align:left; padding:8px">标题</th>
                    <th style="border-bottom:1px solid #eee; text-align:left; padding:8px">文案</th>
                    <th style="border-bottom:1px solid #eee; text-align:left; padding:8px">封面</th>
                    <th style="border-bottom:1px solid #eee; text-align:left; padding:8px">配图</th>
                    <th style="border-bottom:1px solid #eee; text-align:left; padding:8px">封面匹配状态</th>
                    <th style="border-bottom:1px solid #eee; text-align:left; padding:8px">配图匹配状态</th>
                  </tr>
                </thead>
                <tbody id="preview-body"></tbody>
              </table>
            </div>
          </div>
          <div id="publish-pane" style="display:none">
            <div style="display:flex; justify-content:flex-end; align-items:center; gap:8px; margin-bottom:8px">
              <label class="muted">筛选</label>
              <select id="publish-filter" class="btn-small">
                <option value="unpublished" selected>待发布</option>
                <option value="published">已发布</option>
                <option value="all">全部</option>
              </select>
            </div>
            <div id="publish-table-wrap">
              <table id="publish-table" style="width:100%; border-collapse:collapse">
                <thead>
                  <tr>
                    <th style="border-bottom:1px solid #eee; text-align:left; padding:8px">封面</th>
                    <th style="border-bottom:1px solid #eee; text-align:left; padding:8px">标题</th>
                    <th style="border-bottom:1px solid #eee; text-align:left; padding:8px">文案</th>
                    <th style="border-bottom:1px solid #eee; text-align:left; padding:8px">平台</th>
                    <th style="border-bottom:1px solid #eee; text-align:left; padding:8px">是否发布</th>
                    <th style="border-bottom:1px solid #eee; text-align:left; padding:8px">发布时间</th>
                    <th style="border-bottom:1px solid #eee; text-align:left; padding:8px">配图</th>
                    <th style="border-bottom:1px solid #eee; text-align:left; padding:8px">创建时间</th>
                    <th style="border-bottom:1px solid #eee; text-align:left; padding:8px">操作</th>
                  </tr>
                </thead>
                <tbody id="publish-tbody"></tbody>
              </table>
            </div>
            <div id="publish-pager" class="pager"></div>
          </div>
          <div id="task-pane" style="display:none">
            <div style="margin-bottom:12px"><button id="add-slot" class="btn-small">新增时间点</button> <button id="save-slots" class="btn-small" style="margin-left:8px">保存设置</button></div>
            <table style="width:100%; border-collapse:collapse">
              <thead>
                <tr>
                  <th style="border-bottom:1px solid #eee; text-align:left; padding:8px">发布时间</th>
                  <th style="border-bottom:1px solid #eee; text-align:left; padding:8px">发布数量</th>
                  <th style="border-bottom:1px solid #eee; text-align:left; padding:8px">操作</th>
                </tr>
              </thead>
              <tbody id="slots-list"></tbody>
              </table>
            </div>
          <div id="publish-error-panel" class="error-panel">
            <div class="title">发布错误详情</div>
            <div id="publish-error-body"></div>
            <div class="actions">
              <button id="open-devtools" class="btn-small">打开控制台</button>
              <button id="close-error-panel" class="btn-small">关闭</button>
            </div>
          </div>
    </div>
    </div>
    <div class="card" id="autoop-card" style="display:none; margin-top:12px">
      <div style="margin-bottom:12px">
        <div class="muted">自动运营</div>
        <div class="muted" style="font-size:12px">auto_operation</div>
      </div>
      <style>
        .perm-badge { display:inline-block; padding:2px 6px; border-radius:6px; font-size:12px; background:#eee; color:#333; margin-left:8px }
        .disabled { opacity:.5 }
        .area { border:1px solid #e5e5e5; border-radius:10px; padding:10px; margin-bottom:10px }
        .area-title { display:flex; align-items:center; gap:8px; font-weight:bold }
      </style>
      <div id="lv-sections" style="display:grid; grid-template-columns: 1fr; gap:10px; margin-bottom:10px">
        <section id="search-area" class="area">
          <div class="area-title">搜索区域</div>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:8px">
            <div>
              <label>关键词</label>
              <input id="autoop-keywords" type="text" placeholder="多个用逗号分隔" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:6px">
            </div>
            <div>
              <label>行业</label>
              <select id="autoop-industry" class="btn-small" style="width:100%">
                <option value="" disabled selected>加载中...</option>
              </select>
            </div>
          </div>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:8px">
            <div>
              <label>排序依据</label>
              <select id="autoop-sort" class="btn-small" style="width:100%">
                <option value="general" selected>综合</option>
                <option value="time_descending">最新</option>
                <option value="popularity_descending">最多点赞</option>
                <option value="comment_descending">最多评论</option>
                <option value="collect_descending">最多收藏</option>
              </select>
            </div>
            <div>
              <label>笔记类型</label>
              <select id="autoop-type" class="btn-small" style="width:100%">
                <option value="0" selected>不限</option>
                <option value="image_text">图文</option>
                <option value="video">视频</option>
              </select>
            </div>
          </div>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:8px">
            <div>
              <label>发布时间</label>
              <select id="autoop-publish-time" class="btn-small" style="width:100%">
                <option value="不限" selected>不限</option>
                <option value="一天内">一天内</option>
                <option value="一周内">一周内</option>
                <option value="半年内">半年内</option>
              </select>
            </div>
            <div>
              <label>搜索范围</label>
              <select id="autoop-scope" class="btn-small" style="width:100%">
                <option value="0" selected>不限</option>
                <option value="1">已看过</option>
                <option value="2">未看过</option>
                <option value="3">已关注</option>
              </select>
            </div>
          </div>
        </section>
        <section id="lv1-area" class="area">
          <div class="area-title">lv1 功能区域<span class="perm-badge">浏览与搜索</span></div>
          <div style="display:grid; grid-template-columns: repeat(4, auto); gap:12px; align-items:center; margin-top:8px">
            <label><input type="checkbox" id="autoop-browse" data-permission="canBrowse" checked> 浏览</label>
            <label><input type="checkbox" id="autoop-record" checked> 记录浏览信息</label>
          </div>
        </section>
        <section id="lv2-area" class="area">
          <div class="area-title">lv2 功能区域<span class="perm-badge">点赞与收藏</span></div>
          <div style="display:grid; grid-template-columns: repeat(2, auto); gap:12px; align-items:center; margin-top:8px">
            <div style="display:flex; align-items:center; gap:4px">
              <label><input type="checkbox" id="autoop-like" data-permission="canLike"> 点赞</label>
              <input type="number" id="autoop-like-prob" min="0" max="100" value="100" style="width:48px; padding:2px 4px; border:1px solid #ddd; border-radius:4px" title="概率%">%
            </div>
            <div style="display:flex; align-items:center; gap:4px">
              <label><input type="checkbox" id="autoop-fav" data-permission="canFav"> 收藏</label>
              <input type="number" id="autoop-fav-prob" min="0" max="100" value="100" style="width:48px; padding:2px 4px; border:1px solid #ddd; border-radius:4px" title="概率%">%
            </div>
          </div>
        </section>
        <section id="lv3-area" class="area">
          <div class="area-title">lv3 功能区域<span class="perm-badge">评论与回复</span></div>
          <div style="display:grid; grid-template-columns: repeat(1, auto); gap:12px; align-items:center; margin-top:8px">
            <div style="display:flex; align-items:center; gap:4px">
              <label><input type="checkbox" id="autoop-comment" data-permission="canComment"> 评论</label>
              <input type="number" id="autoop-comment-prob" min="0" max="100" value="100" style="width:48px; padding:2px 4px; border:1px solid #ddd; border-radius:4px" title="概率%">%
            </div>
          </div>
        </section>
        <section id="view-area" class="area">
          <div class="area-title">数据查看</div>
          <div style="display:grid; grid-template-columns: repeat(2, auto); gap:12px; align-items:center; margin-top:8px">
            <button id="view-scraped-data" class="btn-small">查看采集</button>
            <button id="view-scraped-comments" class="btn-small">查看评论</button>
          </div>
        </section>
        <section id="risk-area" class="area">
          <div class="area-title">风控区域</div>
          <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin-top:8px">
            <div><label>浏览总量</label><input id="autoop-limit-count" type="number" min="1" value="200" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:6px"></div>
            <div><label>随机延迟(s)</label><input id="autoop-delay-range" type="text" value="1-3" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:6px"></div>
            <div><label>模拟浏览(s)</label><input id="autoop-browse-time" type="text" value="5-10" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:6px"></div>
          </div>
        </section>
      </div>
      
      <div style="margin-bottom:12px">
        <button id="autoop-start" class="btn-small">执行</button>
        <button id="autoop-stop" class="btn-small" style="margin-left:8px">停止</button>
        <span id="autoop-status" class="muted" style="margin-left:12px"></span>
        <button id="autoop-toggle-log" class="btn-small" style="float:right">显示日志</button>
      </div>
      
    </div>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="./services/ipc.js"></script>
    <script src="./utils/images.js"></script>
    <script src="./utils/xlsx.js"></script>
    <script src="./views/login.js"></script>
    <script src="./views/platforms.js"></script>
    <script src="./views/ops.js"></script>
    <script src="./views/autoop.js"></script>
    <script src="./views/autopublish.js"></script>
    <script src="./renderer.js"></script>
    <div id="global-loading" class="loading" style="display:none"><div class="spinner"></div></div>
    <div id="global-toast" class="toast" style="display:none"></div>
    <div id="perm-tooltip" class="tooltip" style="display:none"></div>
    <div id="autoop-floater" style="display:none"></div>
    
    <style>
        .modal-overlay { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; z-index:1000; }
        .modal-box { width:90%; max-width:700px; max-height:85%; background:#fff; border-radius:12px; display:flex; flex-direction:column; box-shadow:0 10px 25px rgba(0,0,0,0.2); }
        .modal-header { padding:16px 20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; font-weight:bold; font-size:16px; }
        .modal-body { flex:1; overflow-y:auto; padding:0; }
        .modal-footer { padding:12px 20px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:12px; align-items:center; }
        .modal-close { cursor:pointer; font-size:20px; color:#999; }
        .modal-close:hover { color:#333; }
        .pagination-info { font-size:14px; color:#666; margin:0 12px; }
    </style>
    <div id="data-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <span id="modal-title">数据查看</span>
                <span id="modal-close" class="modal-close">×</span>
            </div>
            <div class="modal-body">
                <table style="width:100%; border-collapse:collapse; font-size:13px">
                    <thead id="modal-thead" style="position:sticky; top:0; background:#f9f9f9; z-index:1"></thead>
                    <tbody id="modal-tbody"></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button id="modal-prev" class="btn-small" disabled>上一页</button>
                <span id="modal-page-info" class="pagination-info">1 / 1</span>
                <button id="modal-next" class="btn-small" disabled>下一页</button>
            </div>
        </div>
    </div>
  </body>
</html>
